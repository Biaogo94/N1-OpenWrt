name: Build OpenWrt for N1 (Gemini)

on:
  workflow_dispatch:

concurrency:
  group: build-openwrt-n1
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 1.1 Debug - Verify repository structure
        run: |
          echo "=== Current directory ==="
          pwd
          echo ""
          echo "=== All files in workspace ==="
          ls -laR
          echo ""
          echo "=== Checking for N1-LEDE ==="
          if [ -d "N1-LEDE" ]; then
            echo "âœ“ N1-LEDE directory found"
            echo "Contents of N1-LEDE:"
            ls -la N1-LEDE/
          else
            echo "âœ— N1-LEDE directory NOT found"
            echo "All directories:"
            find . -type d -maxdepth 2
          fi

      - name: 2. Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 1
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: 3. Show disk usage after cleanup
        run: df -hT

      - name: 4. Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get -y install \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler fastjar flex gawk \
            gettext genisoimage git gperf haveged help2man intltool libelf-dev libfuse-dev \
            libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev \
            libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz \
            mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 \
            python3 python3-pip python3-pyelftools python3-setuptools qemu-utils rsync \
            scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim \
            wget xmlto xxd zlib1g-dev gn
          sudo timedatectl set-timezone Asia/Shanghai

      - name: 5. Clone OpenWrt source code
        run: |
          if [ ! -d "openwrt" ]; then
            git clone --depth 1 https://github.com/coolsnowwolf/lede -b master openwrt
          else
            echo "OpenWrt directory already exists"
          fi
      
      - name: 6. Load custom files & Run DIY script
        run: |
          echo "=== Verifying N1-LEDE directory ==="
          if [ ! -d "N1-LEDE" ]; then
            echo "::error:: N1-LEDE directory not found!"
            pwd
            ls -la
            exit 1
          fi
          
          echo "=== Contents of N1-LEDE ==="
          ls -la N1-LEDE/
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶ (æ”¯æŒ .config æˆ– .config-all)
          CONFIG_FILE=""
          if [ -f "N1-LEDE/.config" ]; then
            CONFIG_FILE="N1-LEDE/.config"
            echo "âœ“ Found .config file"
          elif [ -f "N1-LEDE/.config-all" ]; then
            CONFIG_FILE="N1-LEDE/.config-all"
            echo "âœ“ Found .config-all file"
          else
            echo "::error:: No .config or .config-all file found!"
            echo "Files in N1-LEDE:"
            ls -la N1-LEDE/
            exit 1
          fi
          
          # æ£€æŸ¥ diy.sh
          if [ ! -f "N1-LEDE/diy.sh" ]; then
            echo "::error:: N1-LEDE/diy.sh not found!"
            echo "Files in N1-LEDE:"
            ls -la N1-LEDE/
            exit 1
          fi
          
          # å¤åˆ¶è‡ªå®šä¹‰æ–‡ä»¶
          if [ -d "N1-LEDE/files" ]; then
            echo "Copying custom files..."
            cp -r N1-LEDE/files openwrt/
          else
            echo "No custom files directory found"
          fi
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          echo "Copying config file: $CONFIG_FILE"
          cp "$CONFIG_FILE" openwrt/.config
          
          # å¤åˆ¶æ’ä»¶ (å¦‚æœå­˜åœ¨)
          if [ -d "N1-LEDE/luci-app-alist" ]; then
            echo "Copying luci-app-alist..."
            mkdir -p openwrt/package/custom
            cp -r N1-LEDE/luci-app-alist openwrt/package/custom/
          fi
          
          # è¿è¡Œè‡ªå®šä¹‰è„šæœ¬
          echo "Running diy.sh..."
          chmod +x N1-LEDE/diy.sh
          cd openwrt
          ../N1-LEDE/diy.sh

      - name: 7. Cache toolchain
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/staging_dir/host
            openwrt/build_dir/host
          key: ${{ runner.os }}-openwrt-toolchain-${{ hashFiles('openwrt/.config') }}
          restore-keys: |
            ${{ runner.os }}-openwrt-toolchain-

      - name: 8. Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-
        
      - name: 9. Update and install feeds
        working-directory: ./openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "### Disk space after feeds install ###"
          df -hT

      - name: 10. Download packages
        working-directory: ./openwrt
        run: |
          make defconfig
          make download -j$(nproc)
          find dl -size -1024c -exec rm -f {} \;
          echo "### Disk space after download ###"
          df -hT

      - name: 11. Compile the firmware
        id: compile
        working-directory: ./openwrt
        run: |
          export USE_CCACHE=1
          export CCACHE_DIR=~/.ccache
          echo "Starting firmware compilation..."
          make -j$(nproc) || make -j1 V=s
          echo "compile_status=$?" >> $GITHUB_OUTPUT
          echo "### Disk space after compile ###"
          df -hT

      - name: 12. Upload build logs on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: build-logs
          path: openwrt/logs/
          retention-days: 7

      - name: 13. Clean up build artifacts
        if: steps.compile.outputs.compile_status == '0'
        working-directory: ./openwrt
        run: |
          echo "Firmware compiled. Cleaning up build artifacts..."
          rm -rf build_dir/target-*
          rm -rf tmp
          echo "### Disk space after cleanup ###"
          df -hT

      - name: 14. Set packaging date
        if: steps.compile.outputs.compile_status == '0'
        run: |
          echo "PACKAGED_OUTPUTDATE=$(date +%Y.%m.%d_%H%M)" >> $GITHUB_ENV

      - name: 15. Package the firmware
        if: steps.compile.outputs.compile_status == '0'
        uses: unifreq/openwrt_packit@master
        env:
          OPENWRT_ARMVIRT: openwrt/bin/targets/*/*/openwrt-armvirt-64-generic-rootfs.tar.gz
          PACKAGE_SOC: s905d
          WHOAMI: fightroad
          KERNEL_AUTO_LATEST: true

      - name: 16. Set packaging status
        if: steps.compile.outputs.compile_status == '0'
        run: |
          if [ -d "/opt/openwrt_packit/output" ] && [ "$(ls -A /opt/openwrt_packit/output)" ]; then
            echo "PACKAGED_STATUS=success" >> $GITHUB_ENV
          else
            echo "PACKAGED_STATUS=failure" >> $GITHUB_ENV
          fi

      - name: 17. Upload to Release
        uses: ncipollo/release-action@v1
        if: env.PACKAGED_STATUS == 'success'
        with:
          tag: OpenWrt_N1_${{ env.PACKAGED_OUTPUTDATE }}
          name: OpenWrt for N1 | ${{ env.PACKAGED_OUTPUTDATE }}
          artifacts: /opt/openwrt_packit/output/*
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            **Lean OpenWrt å›ºä»¶ for Phicomm N1**
            
            ğŸ“… ç¼–è¯‘æ—¶é—´: ${{ env.PACKAGED_OUTPUTDATE }}
            ğŸ”§ SOC: s905d
            ğŸ“¦ æ‰“åŒ…è„šæœ¬: unifreq/openwrt_packit
            
            ### å®‰è£…æ–¹æ³•
            1. å°†å›ºä»¶å†™å…¥ U ç›˜
            2. æ’å…¥ N1 ç›’å­å¹¶ä» U ç›˜å¯åŠ¨
            3. è¿è¡Œ `openwrt-install-amlogic` å®‰è£…åˆ° eMMC

      - name: 18. Delete old releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        if: always()
        with:
          keep_latest: 10
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
