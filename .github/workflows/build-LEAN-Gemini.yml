name: Build OpenWrt for N1 (Gemini)

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  CONFIG_FILE: N1-LEDE/.config-all
  DIY_SH: N1-LEDE/diy.sh
  FILES: N1-LEDE/files
  TZ: Asia/Shanghai

concurrency:
  group: build-openwrt-n1
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@main

      - name: 2. Show disk usage before cleanup
        run: |
          echo "=============================================================================="
          df -hT
          echo "=============================================================================="

      - name: 3. Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 1
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: 4. Show disk usage after cleanup
        run: |
          echo "=============================================================================="
          df -hT
          echo "=============================================================================="

      - name: 5. Install dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get -y install \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler fastjar flex gawk \
            gettext genisoimage git gperf haveged help2man intltool libelf-dev libfuse-dev \
            libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev \
            libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz \
            mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 \
            python3 python3-pip python3-pyelftools python3-setuptools qemu-utils rsync \
            scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim \
            wget xmlto xxd zlib1g-dev gn rename time
          sudo apt-get -y autoremove --purge
          sudo systemctl daemon-reload
          sudo apt-get clean
          sudo timedatectl set-timezone "$TZ"
          sudo chown $USER:$GROUPS $GITHUB_WORKSPACE

      - name: 6. Clone OpenWrt source code
        run: |
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          cd openwrt
          sed -i 's|https://github.com/coolsnowwolf/luci.git;openwrt-23.05|https://github.com/coolsnowwolf/luci|g' feeds.conf.default

      - name: 7. Cache OpenWrt build
        uses: stupidloud/cachewrtbuild@main
        with:
          ccache: 'true'
          mixkey: amlogic-${{ env.REPO_BRANCH }}
          prefix: ${{ github.workspace }}/openwrt

      - name: 8. Update and install feeds
        working-directory: ./openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "### Disk space after feeds install ###"
          df -hT

      - name: 9. Load custom configuration
        run: |
          echo "=== Loading custom files ==="
          [ -e $FILES ] && mv $FILES openwrt/files && echo "âœ“ Custom files moved" || echo "âš  No custom files found"
          
          echo "=== Loading configuration file ==="
          if [ -e $CONFIG_FILE ]; then
            mv $CONFIG_FILE openwrt/.config
            echo "âœ“ Config file moved: $CONFIG_FILE"
          else
            echo "âœ— Config file not found: $CONFIG_FILE"
            exit 1
          fi
          
          echo "=== Running DIY script ==="
          if [ -e $DIY_SH ]; then
            chmod +x $DIY_SH
            cd openwrt
            $GITHUB_WORKSPACE/$DIY_SH
            echo "âœ“ DIY script executed"
          else
            echo "âœ— DIY script not found: $DIY_SH"
            exit 1
          fi

      - name: 10. Download packages
        working-directory: ./openwrt
        run: |
          make defconfig
          make download -j$(nproc)
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
          echo "### Disk space after download ###"
          df -hT

      - name: 11. Compile the firmware
        id: compile
        working-directory: ./openwrt
        run: |
          chmod -R 755 .
          echo "=== Starting compilation with $(nproc) threads ==="
          export USE_CCACHE=1
          export CCACHE_DIR=~/.ccache
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "compile_status=success" >> $GITHUB_OUTPUT
          echo "### Disk space after compile ###"
          df -hT

      - name: 12. Upload build logs on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: build-logs
          path: openwrt/logs/
          retention-days: 7

      - name: 13. Clean up build artifacts
        if: steps.compile.outputs.compile_status == 'success'
        working-directory: ./openwrt
        run: |
          echo "Cleaning up build artifacts..."
          rm -rf build_dir/target-*
          rm -rf tmp
          echo "### Disk space after cleanup ###"
          df -hT

      - name: 14. Set packaging date
        if: steps.compile.outputs.compile_status == 'success'
        run: |
          echo "PACKAGED_OUTPUTDATE=$(date +%Y.%m.%d_%H%M)" >> $GITHUB_ENV

      - name: 15. Package the firmware
        if: steps.compile.outputs.compile_status == 'success'
        uses: unifreq/openwrt_packit@master
        env:
          OPENWRT_ARMVIRT: openwrt/bin/targets/*/*/openwrt-armvirt-64-generic-rootfs.tar.gz
          PACKAGE_SOC: s905d
          WHOAMI: fightroad
          KERNEL_VERSION_NAME: 5.15.176
          KERNEL_AUTO_LATEST: false
          SW_FLOWOFFLOAD: 1
          SFE_FLOW: 0

      - name: 16. Set packaging status
        if: steps.compile.outputs.compile_status == 'success'
        run: |
          if [ -d "/opt/openwrt_packit/output" ] && [ "$(ls -A /opt/openwrt_packit/output)" ]; then
            echo "PACKAGED_STATUS=success" >> $GITHUB_ENV
          else
            echo "PACKAGED_STATUS=failure" >> $GITHUB_ENV
          fi

      - name: 17. Upload to Release
        uses: ncipollo/release-action@v1
        if: env.PACKAGED_STATUS == 'success'
        with:
          tag: OpenWrt_N1_${{ env.PACKAGED_OUTPUTDATE }}
          name: OpenWrt for N1 | ${{ env.PACKAGED_OUTPUTDATE }}
          artifacts: /opt/openwrt_packit/output/*
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            **Lean OpenWrt å›ºä»¶ for Phicomm N1**
            
            ğŸ“… ç¼–è¯‘æ—¶é—´: ${{ env.PACKAGED_OUTPUTDATE }}
            ğŸ”§ SOC: s905d
            ğŸ“¦ æ‰“åŒ…è„šæœ¬: unifreq/openwrt_packit
            ğŸ”¥ åŸºäº Lean æºç : https://github.com/coolsnowwolf/lede
            
            ### åŸºæœ¬ä¿¡æ¯
            - IP: 192.168.2.2
            - è´¦æˆ·: root
            - å¯†ç : password
            
            ### å®‰è£…æ–¹æ³•
            1. å°†å›ºä»¶å†™å…¥ U ç›˜
            2. æ’å…¥ N1 ç›’å­å¹¶ä» U ç›˜å¯åŠ¨
            3. è¿è¡Œ `openwrt-install-amlogic` å®‰è£…åˆ° eMMC
            
            ### æ³¨æ„äº‹é¡¹
            - é¦–æ¬¡ä½¿ç”¨å»ºè®®å…¨æ–°åˆ·å†™
            - å†…æ ¸ç‰ˆæœ¬: 5.15.176
            - å·²å¯ç”¨ SW_FLOWOFFLOAD

      - name: 18. Delete old releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        if: always()
        with:
          keep_latest: 10
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
