name: Build OpenWRT-LEAN for N1(GPT5.1)

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  CONFIG_FILE: N1-LEDE/.config
  DIY_SH: N1-LEDE/diy.sh
  FILES: N1-LEDE/files
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: self-hosted
    timeout-minutes: 480

    steps:
    - name: Check machine configuration
      run: |
        echo "âš ï¸ è­¦å‘Š"
        echo "åˆ†é…çš„æœåŠ¡å™¨æ€§èƒ½æœ‰é™ï¼Œè‹¥é€‰æ‹©çš„æ’ä»¶è¿‡å¤šï¼ŒåŠ¡å¿…æ³¨æ„CPUæ€§èƒ½ï¼"
        echo "äº‘ç¼–è¯‘å»ºè®®å–æ¶ˆå‹¾é€‰Node.jsåŠå…¶ç›¸å…³æ’ä»¶ï¼"
        echo "å·²çŸ¥CPUå‹å·ï¼ˆé™åºï¼‰ï¼š7763,8370C,8272CL,8171M,E5ç³»åˆ—"
        echo "--------------------------CPUä¿¡æ¯--------------------------"
        echo "CPUç‰©ç†æ•°é‡:$(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo -e "CPUæ ¸å¿ƒåŠç‰ˆæœ¬ä¿¡æ¯ï¼š$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
        echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
        echo "å·²å®‰è£…å†…å­˜è¯¦ç»†ä¿¡æ¯ï¼š"
        sudo lshw -short -C memory | grep GiB || echo "å†…å­˜ä¿¡æ¯ä¸å¯ç”¨"
        echo -e "\n"
        echo "--------------------------ç¡¬ç›˜ä¿¡æ¯--------------------------"
        echo -e "ç¡¬ç›˜æ•°é‡ï¼š$(ls /dev/sd* 2>/dev/null | grep -v [1-9] | wc -l) \n"
        echo "ç¡¬ç›˜è¯¦æƒ…ï¼š"
        df -Th

    - name: Checkout
      uses: actions/checkout@v4

    - name: Before freeing up disk space
      run: |
        echo "æ¸…ç†å‰ç£ç›˜ç©ºé—´"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    - name: Free up disk space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: false
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: After freeing up disk space
      run: |
        echo "æ¸…ç†åç£ç›˜ç©ºé—´"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    - name: Initialize environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get update
        sudo -E apt-get -y install \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib \
          g++-multilib gettext genisoimage git gperf haveged help2man intltool libc6-dev-i386 \
          libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev \
          libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool \
          llvm lrzsz libnsl-dev ninja-build p7zip p7zip-full patch pkgconf python3 \
          python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools \
          subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev \
          rename time gn
        sudo -E apt-get -y autoremove --purge
        sudo -E apt-get clean
        sudo timedatectl set-timezone "$TZ"
        echo "ç¼–è¯‘å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"

    - name: Clone source code
      working-directory: ./
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        # ä½¿ç”¨ sed ä¿®æ”¹ feeds é…ç½®
        sed -i 's|^src-git luci.*|src-git luci https://github.com/coolsnowwolf/luci|g' feeds.conf.default
        cat feeds.conf.default

    - name: Cache OpenWrt
      uses: actions/cache@v4
      with:
        path: |
          openwrt/.ccache
          openwrt/staging_dir
          openwrt/build_dir/host
          openwrt/build_dir/hostpkg
        key: openwrt-cache-${{ env.REPO_BRANCH }}-${{ hashFiles('openwrt/feeds.conf.default') }}
        restore-keys: |
          openwrt-cache-${{ env.REPO_BRANCH }}-
          openwrt-cache-

    - name: Update & Install feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load custom config
      run: |
        [ -e $FILES ] && cp -r $FILES openwrt/files
        [ -e $CONFIG_FILE ] && cp $CONFIG_FILE openwrt/.config
        chmod +x $DIY_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_SH
        
    - name: Generate configuration
      working-directory: ./openwrt
      run: |
        make defconfig
        cat .config

    - name: Download packages
      working-directory: ./openwrt
      run: |
        make download -j16
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile firmware
      working-directory: ./openwrt
      run: |
        echo "å¼€å§‹ç¼–è¯‘: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ä½¿ç”¨ $(nproc) çº¿ç¨‹ç¼–è¯‘"
        
        # é…ç½® ccache
        export USE_CCACHE=1
        export CCACHE_DIR=$PWD/.ccache
        ccache -M 10G
        
        # é¦–æ¬¡å°è¯•å¤šçº¿ç¨‹ç¼–è¯‘
        make -j$(nproc) || {
          echo "å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œæ¸…ç†åä½¿ç”¨å•çº¿ç¨‹é‡è¯•..."
          make clean
          make -j1 V=s
        }
        
        echo "ç¼–è¯‘å®Œæˆ: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "COMPILE_STATUS=success" >> $GITHUB_ENV
        echo "COMPILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: Check compile result
      if: env.COMPILE_STATUS == 'success'
      working-directory: ./openwrt
      run: |
        ls -lh bin/targets/*/*/
        echo "FIRMWARE_PATH=$PWD/bin/targets" >> $GITHUB_ENV

    - name: Package OpenWrt firmware
      if: env.COMPILE_STATUS == 'success' && !cancelled()
      uses: unifreq/openwrt_packit@master
      env:
        OPENWRT_ARMVIRT: openwrt/bin/targets/*/*/openwrt-amlogic-mesongx-phicomm_n1-rootfs.tar.gz
        KERNEL_VERSION_NAME: 5.15.176
        KERNEL_AUTO_LATEST: false
        PACKAGE_SOC: s905d
        WHOAMI: fightroad
        SW_FLOWOFFLOAD: 1
        SFE_FLOW: 0

    - name: Check package result
      if: env.COMPILE_STATUS == 'success'
      run: |
        if [ -d "/opt/openwrt_packit/output" ] && [ "$(ls -A /opt/openwrt_packit/output)" ]; then
          echo "PACKAGE_STATUS=success" >> $GITHUB_ENV
          echo "PACKAGE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV
          ls -lh /opt/openwrt_packit/output/
        else
          echo "æ‰“åŒ…è¾“å‡ºç›®å½•ä¸ºç©º"
          echo "PACKAGE_STATUS=failed" >> $GITHUB_ENV
        fi

    - name: Upload firmware to artifact
      if: env.COMPILE_STATUS == 'success' && !cancelled()
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_N1_${{ env.COMPILE_DATE }}
        path: |
          ${{ env.FIRMWARE_PATH }}/*/*
          /opt/openwrt_packit/output/*
        retention-days: 7
        if-no-files-found: warn

    - name: Upload firmware to release
      if: env.PACKAGE_STATUS == 'success' && !cancelled()
      uses: ncipollo/release-action@v1
      with:
        tag: OpenWrt_N1_${{ env.PACKAGE_DATE }}
        name: N1å›ºä»¶ ${{ env.PACKAGE_DATE }}
        artifacts: /opt/openwrt_packit/output/*
        allowUpdates: true
        token: ${{ secrets.GITHUB_TOKEN }}
        body: |
          ## ğŸ“¦ N1 OpenWrt å›ºä»¶
          
          **ç¼–è¯‘æ—¶é—´**: ${{ env.COMPILE_DATE }}
          **åŸºäº**: Lean's LEDE ${{ env.REPO_BRANCH }}
          **å†…æ ¸ç‰ˆæœ¬**: 5.15.176
          
          ### ğŸ“ ä½¿ç”¨è¯´æ˜
          - **é»˜è®¤IP**: 192.168.2.2
          - **ç”¨æˆ·å**: root
          - **å¯†ç **: password
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡ä½¿ç”¨å»ºè®®å…¨æ–°åˆ·å†™
          - åˆ·å†™å‰è¯·å¤‡ä»½é‡è¦æ•°æ®
          
          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          è¯·æ ¹æ®æ‚¨çš„è®¾å¤‡å‹å·é€‰æ‹©å¯¹åº”çš„å›ºä»¶æ–‡ä»¶

    - name: Delete old releases
      uses: dev-drprasad/delete-older-releases@v0.3.4
      if: env.PACKAGE_STATUS == 'success' && !cancelled()
      with:
        keep_latest: 10
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Clean up workspace
      if: always()
      run: |
        echo "æ¸…ç†å·¥ä½œç©ºé—´"
        df -hT
        rm -rf openwrt/build_dir openwrt/tmp || true
        echo "æ¸…ç†å®Œæˆ"
        df -hT
