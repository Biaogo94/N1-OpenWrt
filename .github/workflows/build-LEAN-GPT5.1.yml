name: Build OpenWRT-LEAN for N1(GPT5.1)

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  CONFIG_FILE: N1-LEDE/.config-all
  DIY_SH: N1-LEDE/diy.sh
  FILES: N1-LEDE/files
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 480

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Verify repository structure
      run: |
        echo "ä»“åº“ç»“æ„æ£€æŸ¥ï¼š"
        echo "=============================================================================="
        ls -la
        echo "------------------------------------------------------------------------------"
        echo "N1-LEDE ç›®å½•å†…å®¹ï¼š"
        ls -la N1-LEDE/ || echo "N1-LEDE ç›®å½•ä¸å­˜åœ¨!"
        echo "=============================================================================="

    - name: Check initial disk space
      run: |
        echo "âš ï¸ GitHub Actions Runner ç£ç›˜ç©ºé—´æœ‰é™"
        echo "åˆå§‹ç£ç›˜ç©ºé—´ï¼š"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 1024
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'

    - name: Check disk space after cleanup
      run: |
        echo "æ¸…ç†åç£ç›˜ç©ºé—´ï¼š"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="
        echo "--------------------------CPUä¿¡æ¯--------------------------"
        echo "CPUç‰©ç†æ•°é‡: $(cat /proc/cpuinfo | grep "physical id" | sort | uniq | wc -l)"
        echo "CPUæ ¸å¿ƒä¿¡æ¯: $(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c)"
        echo "--------------------------å†…å­˜ä¿¡æ¯--------------------------"
        free -h

    - name: Initialize environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        docker rmi $(docker images -q) 2>/dev/null || true
        sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d /usr/local/lib/android 2>/dev/null || true
        sudo -E apt-get -y purge azure-cli* docker* ghc* zulu* llvm* firefox google* dotnet* powershell* openjdk* mysql* php* mongodb* moby* snap* 2>/dev/null || true
        sudo -E apt-get update
        sudo -E apt-get -y install \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib \
          g++-multilib gettext genisoimage git gperf haveged help2man intltool libc6-dev-i386 \
          libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev \
          libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool \
          llvm lrzsz libnsl-dev ninja-build p7zip p7zip-full patch pkgconf python3 \
          python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools \
          subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev \
          rename time gn
        sudo -E apt-get -y autoremove --purge
        sudo -E apt-get clean
        sudo timedatectl set-timezone "$TZ"
        echo "ç¼–è¯‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ: $(date '+%Y-%m-%d %H:%M:%S')"

    - name: Clone source code
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        sed -i 's|^src-git luci.*|src-git luci https://github.com/coolsnowwolf/luci|g' feeds.conf.default
        echo "æºç å…‹éš†å®Œæˆ"

    - name: Cache
      uses: klever1988/cachewrtbuild@main
      with:
        ccache: 'true'
        mixkey: 'n1-openwrt'
        prefix: ${{ github.workspace }}/openwrt

    - name: Update & Install feeds
      working-directory: ./openwrt
      run: |
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load custom configuration
      run: |
        echo "=============================================================================="
        echo "åŠ è½½è‡ªå®šä¹‰é…ç½®..."
        echo "=============================================================================="
        
        # å¤åˆ¶ files ç›®å½•
        if [ -d "$FILES" ]; then
          echo "âœ“ å¤åˆ¶ files ç›®å½•"
          cp -r $FILES openwrt/files
          ls -la openwrt/files
        else
          echo "âš  files ç›®å½•ä¸å­˜åœ¨: $FILES"
        fi
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        if [ -f "$CONFIG_FILE" ]; then
          echo "âœ“ å¤åˆ¶é…ç½®æ–‡ä»¶: $CONFIG_FILE"
          cp $CONFIG_FILE openwrt/.config
        elif [ -f "N1-LEDE/.config" ]; then
          echo "âœ“ ä½¿ç”¨ N1-LEDE/.config"
          cp N1-LEDE/.config openwrt/.config
        else
          echo "âœ— é”™è¯¯: æ‰¾ä¸åˆ°é…ç½®æ–‡ä»¶!"
          echo "æŸ¥æ‰¾çš„è·¯å¾„: $CONFIG_FILE"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la N1-LEDE/
          exit 1
        fi
        
        # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
        if [ -f "$DIY_SH" ]; then
          echo "âœ“ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬: $DIY_SH"
          chmod +x $DIY_SH
          cd openwrt
          bash $GITHUB_WORKSPACE/$DIY_SH
        else
          echo "âš  è‡ªå®šä¹‰è„šæœ¬ä¸å­˜åœ¨: $DIY_SH"
        fi
        
        echo "=============================================================================="
        echo "é…ç½®åŠ è½½å®Œæˆ"
        echo "=============================================================================="

    - name: Generate configuration
      working-directory: ./openwrt
      run: |
        make defconfig
        echo "ç”Ÿæˆçš„é…ç½®æ‘˜è¦:"
        grep -v '^#' .config | grep '=' | head -20 || true

    - name: Download packages
      working-directory: ./openwrt
      run: |
        make download -j16
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: Check disk space before compile
      run: |
        echo "ç¼–è¯‘å‰ç£ç›˜ç©ºé—´ï¼š"
        df -hT

    - name: Compile firmware
      working-directory: ./openwrt
      run: |
        echo "å¼€å§‹ç¼–è¯‘: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ä½¿ç”¨ $(nproc) çº¿ç¨‹ç¼–è¯‘"
        make -j$(($(nproc) + 1)) V=s || {
          echo "å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œä½¿ç”¨å•çº¿ç¨‹é‡è¯•..."
          make -j1 V=s
        }
        echo "ç¼–è¯‘å®Œæˆ: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "COMPILE_STATUS=success" >> $GITHUB_ENV
        echo "COMPILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: Check compile result
      if: env.COMPILE_STATUS == 'success'
      working-directory: ./openwrt
      run: |
        echo "ç¼–è¯‘äº§ç‰©ï¼š"
        ls -lh bin/targets/*/*/ || echo "æœªæ‰¾åˆ°ç¼–è¯‘äº§ç‰©"
        echo "FIRMWARE_PATH=$PWD/bin/targets" >> $GITHUB_ENV

    - name: Organize firmware files
      if: env.COMPILE_STATUS == 'success'
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE_DIR=$PWD" >> $GITHUB_ENV
        echo "æ•´ç†åçš„æ–‡ä»¶ï¼š"
        ls -lh

    - name: Package OpenWrt firmware
      if: env.COMPILE_STATUS == 'success' && !cancelled()
      uses: unifreq/openwrt_packit@master
      env:
        OPENWRT_ARMVIRT: openwrt/bin/targets/*/*/openwrt-amlogic-mesongx-phicomm_n1-rootfs.tar.gz
        KERNEL_VERSION_NAME: 5.15.176
        KERNEL_AUTO_LATEST: false
        PACKAGE_SOC: s905d
        WHOAMI: Biaogo94
        SW_FLOWOFFLOAD: 1
        SFE_FLOW: 0

    - name: Check package result
      if: env.COMPILE_STATUS == 'success'
      run: |
        if [ -d "/opt/openwrt_packit/output" ] && [ -n "$(ls -A /opt/openwrt_packit/output 2>/dev/null)" ]; then
          echo "PACKAGE_STATUS=success" >> $GITHUB_ENV
          echo "PACKAGE_DATE=$(date +"%Y.%m.%d_%H%M")" >> $GITHUB_ENV
          echo "æ‰“åŒ…æˆåŠŸï¼Œè¾“å‡ºæ–‡ä»¶ï¼š"
          ls -lh /opt/openwrt_packit/output/
        else
          echo "PACKAGE_STATUS=failed" >> $GITHUB_ENV
          echo "æ‰“åŒ…å¤±è´¥æˆ–è¾“å‡ºç›®å½•ä¸ºç©º"
        fi

    - name: Upload firmware to artifact
      if: env.COMPILE_STATUS == 'success' && !cancelled()
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_N1_${{ env.COMPILE_DATE }}
        path: |
          ${{ env.FIRMWARE_DIR }}/*
        retention-days: 7
        if-no-files-found: warn

    - name: Upload packaged firmware to artifact
      if: env.PACKAGE_STATUS == 'success' && !cancelled()
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_N1_Packaged_${{ env.COMPILE_DATE }}
        path: /opt/openwrt_packit/output/*
        retention-days: 7

    - name: Upload firmware to release
      if: env.PACKAGE_STATUS == 'success' && !cancelled()
      uses: ncipollo/release-action@v1
      with:
        tag: OpenWrt_N1_${{ env.PACKAGE_DATE }}
        name: N1 å›ºä»¶ ${{ env.PACKAGE_DATE }}
        artifacts: /opt/openwrt_packit/output/*
        allowUpdates: true
        token: ${{ secrets.GITHUB_TOKEN }}
        body: |
          ## ğŸ“¦ æ–è®¯ N1 OpenWrt å›ºä»¶
          
          **ç¼–è¯‘æ—¶é—´**: ${{ env.PACKAGE_DATE }}
          **å›ºä»¶æºç **: [Lean's LEDE](${{ env.REPO_URL }})
          **æºç åˆ†æ”¯**: ${{ env.REPO_BRANCH }}
          **å†…æ ¸ç‰ˆæœ¬**: 5.15.176
          **SOC å‹å·**: S905D
          
          ### ğŸ“ ä½¿ç”¨è¯´æ˜
          - **é»˜è®¤ IP**: 192.168.2.2
          - **ç”¨æˆ·å**: root
          - **å¯†ç **: password
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡ä½¿ç”¨å»ºè®®å…¨æ–°åˆ·å†™
          - åˆ·å†™å‰è¯·å¤‡ä»½é‡è¦æ•°æ®
          - åˆ·å†™æ–¹æ³•è¯·å‚è€ƒç›¸å…³æ•™ç¨‹
          
          ### ğŸ“¥ æ–‡ä»¶è¯´æ˜
          - `*-s905d-*.img.gz`: N1 ä¸“ç”¨å›ºä»¶é•œåƒï¼ˆå‹ç¼©åŒ…ï¼‰
          - ä¸‹è½½åè§£å‹å¾—åˆ° .img æ–‡ä»¶
          - ä½¿ç”¨ balenaEtcher æˆ– USBwriter ç­‰å·¥å…·å†™å…¥ Uç›˜/TFå¡

    - name: Delete older releases
      if: env.PACKAGE_STATUS == 'success' && !cancelled()
      uses: dev-drprasad/delete-older-releases@v0.3.4
      with:
        keep_latest: 10
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Final disk space check
      if: always()
      run: |
        echo "æœ€ç»ˆç£ç›˜ç©ºé—´ï¼š"
        df -hT
